name: Build and Publish OpenMRS

on:
  push:
    branches: [ master, dev, 'release-*' ]
    tags: [ '[0-9]+.[0-9]+.[0-9]+' ]
    paths-ignore: [ "**.md" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      IMAGE_NAME: openmrs
      HELM_CHART_PATH: package/helm/openmrs

    steps:
      # ───────────────────────────── CHECKOUT ─────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ───────────────────── VERSION USING COMMIT HASH ────────────────────
      - name: Set version
        run: echo "ARTIFACT_VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # ─────────────────────────── JAVA + MAVEN ────────────────────────────
      - name: Setup JDK 1.8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      - name: Make mvnw executable
        run: chmod +x ./mvnw
        
      - name: Cache Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2

      - name: Build with Maven
        run: ./mvnw -U --no-transfer-progress clean install

      # ───────────────────────────── BUILDX ────────────────────────────────
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ─────────────────────────── DOCKER HUB LOGIN ────────────────────────
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # ───────────────────── MULTI-ARCH BUILD & PUSH ───────────────────────
      - name: Build & Push Docker Image (Multi-Arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: package/docker/openmrs/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.ARTIFACT_VERSION }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

     
